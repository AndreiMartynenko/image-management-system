@page "{serviceId:int}"
@model HealthcareIMS.Pages.Doctor.ServiceDetailsModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="container mt-4">
    <h2>Service Details (Doctor)</h2>

    <div asp-validation-summary="All" class="text-danger"></div>

    @if (Model.ServiceData == null)
    {
        <div class="alert alert-danger">Service not found or you have no permission.</div>
        <a asp-page="/Doctor/Index" class="btn btn-secondary">Back</a>
    }
    else
    {
        <dl class="row">
            <dt class="col-sm-3">Service Name</dt>
            <dd class="col-sm-9">@Model.ServiceData.ServiceName (@Model.ServiceData.ServiceCategory)</dd>

            <dt class="col-sm-3">Patient</dt>
            <dd class="col-sm-9">@Model.PatientName</dd>

            <dt class="col-sm-3">Cost</dt>
            <dd class="col-sm-9">@Model.ServiceData.ServiceCost</dd>

            <dt class="col-sm-3">Date</dt>
            <dd class="col-sm-9">@Model.ServiceData.ServiceDate.ToString("yyyy-MM-dd HH:mm")</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">@Model.ServiceData.ServiceStatus</dd>

            <dt class="col-sm-3">Diagnosis</dt>
            <dd class="col-sm-9">@Model.ServiceData.Diagnosis</dd>

            <dt class="col-sm-3">Comments</dt>
            <dd class="col-sm-9">@Model.ServiceData.Comments</dd>
        </dl>

        <hr />

        <!-- فرم بروزرسانی Diagnosis و Comments -->
        <form method="post" class="border p-3 mb-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="serviceId" value="@Model.ServiceData.Id" />

            <div class="mb-3">
                <label>Update Diagnosis</label>
                <textarea asp-for="UpdatedDiagnosis" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label>Update Comments</label>
                <textarea asp-for="UpdatedComments" class="form-control" rows="2"></textarea>
            </div>

            <button type="submit" asp-page-handler="UpdateDiagnosis" class="btn btn-primary">Save Diagnosis/Comments</button>
            <a asp-page="/Doctor/Index" class="btn btn-secondary">Back</a>
        </form>

        <!-- Finish Visit -->
        <form method="post" asp-page-handler="FinishVisit" class="d-inline">
            @Html.AntiForgeryToken()
            <input type="hidden" name="serviceId" value="@Model.ServiceData.Id" />
            <button type="submit" class="btn btn-success">Finish Visit</button>
        </form>

        <!-- Refer -->
        <button class="btn btn-warning ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#referSection">
            Refer
        </button>

        <div id="referSection" class="collapse mt-3">
            <form method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="serviceId" value="@Model.ServiceData.Id" />

                <!-- بخش 1: انتخاب Category -->
                <div class="mb-3">
                    <label>Department (Category)</label>
                    <select asp-for="SelectedCategory" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Select Department --</option>
                        @foreach (var cat in Model.AllCategories)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>

                <!-- بخش 2: انتخاب ServiceDefinition -->
                <div class="mb-3">
                    <label>Service</label>
                    <select asp-for="SelectedServiceDefinitionId" class="form-select">
                        <option value="">-- Select Service --</option>
                        @if (Model.FilteredServiceDefinitions != null)
                        {
                            foreach (var sd in Model.FilteredServiceDefinitions)
                            {
                                <option value="@sd.Id">@sd.Name (@sd.DefaultCost)</option>
                            }
                        }
                    </select>
                </div>

                <button type="submit" asp-page-handler="ReferConfirm" class="btn btn-warning">Confirm Refer</button>
            </form>
        </div>

        <hr />

        <h5>Other Services in This Visit</h5>
        @if (Model.ServicesInSameVisit != null && Model.ServicesInSameVisit.Any())
        {
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Service Name</th>
                        <th>Doctor</th>
                        <th>Status</th>
                        <th>Diagnosis</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int rowNum = 1;
                    }
                    @foreach (var s in Model.ServicesInSameVisit)
                    {
                        var rowClass = (s.Id == Model.ServiceData.Id) ? "table-active" : "";
                        <tr class="@rowClass">
                            <td>@rowNum</td>
                            <td>@s.ServiceName (@s.ServiceCategory)</td>
                            <td>@(s.Doctor?.User?.FirstName) @(s.Doctor?.User?.LastName)</td>
                            <td>@s.ServiceStatus</td>
                            <td>@s.Diagnosis</td>
                            <td>@s.ServiceDate.ToString("yyyy-MM-dd HH:mm")</td>
                        </tr>
                        rowNum++;
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No other services found for this Visit.</p>
        }

        <hr />
        <h5>Images for this Visit</h5>
        @if (Model.ImagingList != null && Model.ImagingList.Any())
        {
            <ul>
                @foreach (var img in Model.ImagingList)
                {
                    <li>
                        @img.ImagingType / @img.DiseaseType --
                        <a href="@img.ImageFile" download>Download</a>
                    </li>
                }
            </ul>
        }
        else
        {
            <p>No images uploaded for this visit.</p>
        }
    }
</div>
